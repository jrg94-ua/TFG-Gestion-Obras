@page "/proyectos/{ProyectoId:int}/gantt"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using GestionObras.Core.Entities
@using GestionObras.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@inject GestionObrasDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Diagrama de Gantt - @proyecto?.Nombre</PageTitle>

<div class="container-fluid gantt-page">
    @if (proyecto == null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else
    {
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="bi bi-bar-chart-steps"></i> Diagrama de Gantt</h1>
                    <h4 class="text-muted">Proyecto: @proyecto.Nombre</h4>
                </div>
                <button class="btn btn-secondary" @onclick="Volver">
                    <i class="bi bi-arrow-left"></i> Volver a Proyectos
                </button>
            </div>
        </div>

        <!-- Barra de herramientas -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Vista:</label>
                        <select class="form-select" @bind="vistaSeleccionada" @bind:after="CambiarVista">
                            <option value="dia">Día</option>
                            <option value="semana">Semana</option>
                            <option value="mes">Mes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Mostrar:</label>
                        <select class="form-select" @bind="filtroEstado" @bind:after="AplicarFiltros">
                            <option value="">Todas las tareas</option>
                            <option value="Pendiente">Pendientes</option>
                            <option value="EnCurso">En Curso</option>
                            <option value="Finalizado">Finalizadas</option>
                            <option value="Bloqueado">Bloqueadas</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" @onclick="ZoomIn">
                                <i class="bi bi-zoom-in"></i> Acercar
                            </button>
                            <button class="btn btn-outline-primary" @onclick="ZoomOut">
                                <i class="bi bi-zoom-out"></i> Alejar
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="HoyButton">
                                <i class="bi bi-calendar-day"></i> Hoy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leyenda -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex gap-4">
                    <div><span class="badge" style="background-color: #4CAF50;">■</span> Finalizado</div>
                    <div><span class="badge" style="background-color: #2196F3;">■</span> En Curso</div>
                    <div><span class="badge" style="background-color: #FFC107;">■</span> Pendiente</div>
                    <div><span class="badge" style="background-color: #F44336;">■</span> Bloqueado</div>
                </div>
            </div>
        </div>

        <!-- Contenedor del diagrama de Gantt -->
        <div class="card">
            <div class="card-body p-0 gantt-block">
                <div id="gantt-top-scroll" class="gantt-top-scroll">
                    <div class="gantt-top-scroll-content" style="width: @(280 + AnchoTimelinePx())px;"></div>
                </div>
                <div id="gantt-container" class="gantt-container-scroll">
                    @if (!tareasFiltradas.Any())
                    {
                        <div class="text-center p-5">
                            <i class="bi bi-info-circle fs-1 text-muted"></i>
                            <p class="text-muted mt-3">No hay tareas para mostrar en el diagrama</p>
                        </div>
                    }
                    else
                    {
                        <div class="gantt-chart">
                            <div class="gantt-header sticky-top">
                                <div class="gantt-header-left">
                                    <div class="gantt-header-title">Tarea / Estado</div>
                                </div>
                                <div class="gantt-header-right" style="min-width: @(AnchoTimelinePx())px;">
                                    <div class="gantt-header-primary">
                                        @foreach (var grupo in cabeceraPrimaria)
                                        {
                                            <div class="gantt-header-group" style="width: @(grupo.Span * anchoColumnaPx)px;">
                                                @grupo.Label
                                            </div>
                                        }
                                    </div>
                                    <div class="gantt-header-secondary">
                                        @foreach (var fecha in fechasTimeline)
                                        {
                                            <div class="gantt-date-cell @(EsFinDeSemana(fecha) ? "weekend" : "")" style="width: @(anchoColumnaPx)px;">
                                                @FormatearFecha(fecha)
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="gantt-rows">
                                @foreach (var tarea in tareasFiltradas.OrderBy(t => t.FechaInicio).ThenBy(t => t.Nivel))
                                {
                                    var barra = CalcularPosicionBarra(tarea);
                                    var porcentaje = ObtenerProgresoTarea(tarea);
                                    <div class="gantt-row">
                                        <div class="gantt-task-name">
                                            <div class="task-name-content" style="padding-left: @(8 + (tarea.Nivel * 18))px;">
                                                <span class="task-level-icon">@(tarea.Nivel > 0 ? "↳" : "•")</span>
                                                <strong title="@tarea.Nombre">@tarea.Nombre</strong>
                                            </div>
                                            <div class="task-meta">
                                                <span class="badge bg-light text-dark border">@GetEstadoTexto(tarea.Estado)</span>
                                                <span class="text-muted">@ObtenerDuracionDias(tarea) días</span>
                                            </div>
                                        </div>

                                        <div class="gantt-timeline-row" style="min-width: @(AnchoTimelinePx())px;">
                                            <div class="gantt-grid-track">
                                                @foreach (var fecha in fechasTimeline)
                                                {
                                                    <div class="gantt-grid-cell @(EsFinDeSemana(fecha) ? "weekend" : "")" style="width: @(anchoColumnaPx)px;"></div>
                                                }
                                            </div>

                                            @if (EsHoyVisible())
                                            {
                                                <div class="today-line" style="left: @(ObtenerLeftHoy())px;"></div>
                                            }

                                            <div class="gantt-bar @ObtenerClaseBarra(tarea.Estado) @(tarea.Prioridad == PrioridadTarea.Critica ? "bar-critical" : "")"
                                                 style="left: @(barra.Left)px; width: @(barra.Width)px;"
                                                 @onclick="() => MostrarDetallesTarea(tarea)"
                                                 title="@tarea.Nombre&#10;Inicio: @tarea.FechaInicio.ToString("dd/MM/yyyy")&#10;Fin: @(tarea.FechaFin?.ToString("dd/MM/yyyy") ?? "Sin definir")&#10;Progreso: @porcentaje%">
                                                <div class="gantt-bar-progress" style="width: @porcentaje%;"></div>
                                                <span class="gantt-bar-label">@porcentaje%</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Resumen estadístico -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Total Tareas</h6>
                        <h3>@tareasFiltradas.Count</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Duración Total</h6>
                        <h3>@CalcularDuracionTotal() días</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Progreso</h6>
                        <h3>@CalcularProgreso()%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Fecha Fin Estimada</h6>
                        <h3>@ObtenerFechaFinEstimada()</h3>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .page-header {
        padding-bottom: 1rem;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 2rem;
    }

    .gantt-page {
        width: 100%;
        max-width: 100%;
        overflow-x: clip;
    }

    .gantt-block {
        position: relative;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    .gantt-chart {
        display: flex;
        flex-direction: column;
        background: var(--bs-body-bg);
    }

    .gantt-top-scroll {
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        overscroll-behavior-x: contain;
        height: 16px;
        border-bottom: 1px solid var(--bs-border-color-translucent);
    }

    .gantt-top-scroll-content {
        height: 1px;
    }

    .gantt-container-scroll {
        width: 100%;
        max-width: 100%;
        height: 70vh;
        min-height: 500px;
        max-height: 760px;
        overflow: auto;
        overscroll-behavior: contain;
    }

    .gantt-header {
        display: flex;
        z-index: 5;
        background: var(--bs-light);
        border-bottom: 2px solid var(--bs-border-color);
    }

    .gantt-header-left {
        width: 280px;
        min-width: 280px;
        border-right: 2px solid var(--bs-border-color);
        background: var(--bs-light);
        position: sticky;
        left: 0;
        z-index: 6;
    }

    .gantt-header-title {
        padding: 0.9rem;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .gantt-header-right {
        display: flex;
        flex-direction: column;
    }

    .gantt-header-primary,
    .gantt-header-secondary {
        display: flex;
    }

    .gantt-header-group {
        text-align: center;
        font-weight: 600;
        font-size: 0.8rem;
        border-right: 1px solid var(--bs-border-color);
        padding: 0.4rem 0.2rem;
        background: #eef3f8;
    }

    .gantt-rows {
        display: flex;
        flex-direction: column;
    }

    .gantt-row {
        display: flex;
        min-height: 62px;
    }

    .gantt-row:hover {
        background-color: #f8f9fa;
    }

    .gantt-task-name {
        width: 280px;
        min-width: 280px;
        border-right: 2px solid var(--bs-border-color);
        border-bottom: 1px solid var(--bs-border-color-translucent);
        background: white;
        padding: 0.5rem 0.65rem;
        position: sticky;
        left: 0;
        z-index: 3;
    }

    .task-name-content {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .task-level-icon {
        color: var(--bs-secondary);
        font-size: 0.85rem;
    }

    .task-meta {
        margin-top: 0.35rem;
        display: flex;
        gap: 0.45rem;
        align-items: center;
        font-size: 0.75rem;
    }

    .gantt-timeline-row {
        position: relative;
        border-bottom: 1px solid var(--bs-border-color-translucent);
        background: white;
    }

    .gantt-date-cell {
        border-right: 1px solid var(--bs-border-color-translucent);
        text-align: center;
        padding: 0.45rem 0.2rem;
        font-size: 0.76rem;
        font-weight: 600;
        background: white;
    }

    .gantt-grid-track {
        display: flex;
        height: 100%;
        min-height: 62px;
    }

    .gantt-grid-cell {
        border-right: 1px solid var(--bs-border-color-translucent);
    }

    .weekend {
        background: rgba(108, 117, 125, 0.07);
    }

    .today-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--bs-danger);
        opacity: 0.8;
        z-index: 2;
    }

    .gantt-bar {
        position: absolute;
        top: 15px;
        height: 30px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        display: flex;
        align-items: center;
        overflow: hidden;
        z-index: 3;
        color: #fff;
        font-size: 0.76rem;
        font-weight: 600;
    }

    .gantt-bar-progress {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.2);
    }

    .gantt-bar-label {
        position: relative;
        z-index: 1;
        width: 100%;
        text-align: center;
    }

    .bar-pendiente { background-color: #f0ad4e; }
    .bar-encurso { background-color: #0d6efd; }
    .bar-finalizado { background-color: #198754; }
    .bar-bloqueado { background-color: #dc3545; }

    .bar-critical {
        outline: 2px solid rgba(33, 37, 41, 0.45);
    }

    .gantt-bar:hover {
        opacity: 0.9;
        transform: translateY(-2px);
        transition: all 0.2s;
    }

    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: none;
        border-radius: 8px;
    }
</style>

@code {
    [Parameter]
    public int ProyectoId { get; set; }

    private Proyecto? proyecto;
    private List<Tarea> tareas = new();
    private List<Tarea> tareasFiltradas = new();
    
    private string vistaSeleccionada = "semana";
    private string filtroEstado = "";
    private int zoomLevel = 1;
    private int anchoColumnaPx = 90;

    private DateTime fechaInicio;
    private DateTime fechaFin;
    private List<DateTime> fechasTimeline = new();
    private List<TimelineHeaderGroup> cabeceraPrimaria = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (proyecto != null)
        {
            await JS.InvokeVoidAsync("gestionObrasGanttScroll.init", "gantt-top-scroll", "gantt-container");
        }
    }

    private async Task CargarDatos()
    {
        proyecto = await DbContext.Proyectos
            .FirstOrDefaultAsync(p => p.Id == ProyectoId);

        if (proyecto != null)
        {
            tareas = await DbContext.Tareas
                .Where(t => t.ProyectoId == ProyectoId)
                .OrderBy(t => t.FechaInicio)
                .ToListAsync();

            AplicarFiltros();
            CalcularRangoFechas();
            RecalcularTimeline();
        }
    }

    private void AplicarFiltros()
    {
        tareasFiltradas = tareas.ToList();

        if (!string.IsNullOrEmpty(filtroEstado) && Enum.TryParse<EstadoTarea>(filtroEstado, out var estado))
        {
            tareasFiltradas = tareasFiltradas.Where(t => t.Estado == estado).ToList();
        }

        CalcularRangoFechas();
        RecalcularTimeline();
    }

    private void CalcularRangoFechas()
    {
        if (!tareasFiltradas.Any())
        {
            fechaInicio = DateTime.Today.AddDays(-14);
            fechaFin = DateTime.Today.AddDays(30);
            return;
        }

        fechaInicio = tareasFiltradas.Min(t => t.FechaInicio).AddDays(-7);
        fechaFin = tareasFiltradas.Where(t => t.FechaFin.HasValue).Any() 
            ? tareasFiltradas.Where(t => t.FechaFin.HasValue).Max(t => t.FechaFin!.Value).AddDays(7)
            : DateTime.Today.AddDays(30);

        if (DateTime.Today < fechaInicio)
        {
            fechaInicio = DateTime.Today.AddDays(-7);
        }
        if (DateTime.Today > fechaFin)
        {
            fechaFin = DateTime.Today.AddDays(14);
        }
    }

    private void RecalcularTimeline()
    {
        fechasTimeline.Clear();
        var fecha = fechaInicio;

        while (fecha <= fechaFin)
        {
            fechasTimeline.Add(fecha);
            fecha = vistaSeleccionada switch
            {
                "dia" => fecha.AddDays(1),
                "semana" => fecha.AddDays(7),
                "mes" => fecha.AddMonths(1),
                _ => fecha.AddDays(7)
            };
        }

        ConstruirCabeceraPrimaria();
    }

    private void ConstruirCabeceraPrimaria()
    {
        cabeceraPrimaria = new();
        if (!fechasTimeline.Any())
        {
            return;
        }

        string GetKey(DateTime f) => vistaSeleccionada switch
        {
            "mes" => f.ToString("yyyy"),
            _ => f.ToString("yyyy-MM")
        };

        string GetLabel(DateTime f) => vistaSeleccionada switch
        {
            "mes" => f.ToString("yyyy"),
            _ => f.ToString("MMMM yyyy")
        };

        var actual = fechasTimeline[0];
        var keyActual = GetKey(actual);
        var span = 0;

        foreach (var fecha in fechasTimeline)
        {
            var key = GetKey(fecha);
            if (key != keyActual)
            {
                cabeceraPrimaria.Add(new TimelineHeaderGroup(GetLabel(actual), span));
                actual = fecha;
                keyActual = key;
                span = 0;
            }

            span++;
        }

        cabeceraPrimaria.Add(new TimelineHeaderGroup(GetLabel(actual), span));
    }

    private string FormatearFecha(DateTime fecha)
    {
        return vistaSeleccionada switch
        {
            "dia" => fecha.ToString("dd MMM"),
            "semana" => $"S{GetWeekOfYear(fecha)} {fecha.ToString("MMM")}",
            "mes" => fecha.ToString("MMM"),
            _ => fecha.ToString("dd/MM")
        };
    }

    private int GetWeekOfYear(DateTime date)
    {
        var culture = System.Globalization.CultureInfo.CurrentCulture;
        return culture.Calendar.GetWeekOfYear(date, System.Globalization.CalendarWeekRule.FirstDay, DayOfWeek.Monday);
    }

    private (int Left, int Width) CalcularPosicionBarra(Tarea tarea)
    {
        var anchoCelda = anchoColumnaPx;
        var diasPorCelda = DiasPorCelda();

        var diasDesdeInicio = (tarea.FechaInicio - fechaInicio).TotalDays;

        var left = (diasDesdeInicio / diasPorCelda) * anchoCelda;
        
        var duracion = tarea.FechaFin.HasValue 
            ? (tarea.FechaFin.Value - tarea.FechaInicio).TotalDays 
            : 1;
        
        var width = (duracion / diasPorCelda) * anchoCelda;
        
        if (width < 24) width = 24;

        return ((int)Math.Round(left), (int)Math.Round(width));
    }

    private int DiasPorCelda()
    {
        return vistaSeleccionada switch
        {
            "dia" => 1,
            "semana" => 7,
            "mes" => 30,
            _ => 7
        };
    }

    private string GetColorEstado(EstadoTarea estado)
    {
        return estado switch
        {
            EstadoTarea.Finalizado => "#4CAF50",
            EstadoTarea.EnCurso => "#2196F3",
            EstadoTarea.Pendiente => "#FFC107",
            EstadoTarea.Bloqueado => "#F44336",
            _ => "#9E9E9E"
        };
    }

    private string GetEstadoTexto(EstadoTarea estado)
    {
        return estado switch
        {
            EstadoTarea.Finalizado => "Finalizado",
            EstadoTarea.EnCurso => "En Curso",
            EstadoTarea.Pendiente => "Pendiente",
            EstadoTarea.Bloqueado => "Bloqueado",
            _ => estado.ToString()
        };
    }

    private void CambiarVista()
    {
        ActualizarZoom();
    }

    private void ZoomIn()
    {
        if (zoomLevel < 3)
        {
            zoomLevel++;
            ActualizarZoom();
        }
    }

    private void ZoomOut()
    {
        if (zoomLevel > 1)
        {
            zoomLevel--;
            ActualizarZoom();
        }
    }

    private void ActualizarZoom()
    {
        var baseWidth = vistaSeleccionada switch
        {
            "dia" => 44,
            "semana" => 70,
            "mes" => 92,
            _ => 70
        };

        anchoColumnaPx = baseWidth * zoomLevel;
        RecalcularTimeline();
    }

    private void HoyButton()
    {
        CalcularRangoFechas();
        RecalcularTimeline();
    }

    private void MostrarDetallesTarea(Tarea tarea)
    {
        // Navegar a los detalles de la tarea o mostrar modal
        Navigation.NavigateTo($"/proyectos/{ProyectoId}/kanban");
    }

    private int CalcularDuracionTotal()
    {
        if (!tareas.Any()) return 0;
        
        var inicio = tareas.Min(t => t.FechaInicio);
        var fin = tareas.Where(t => t.FechaFin.HasValue).Any()
            ? tareas.Where(t => t.FechaFin.HasValue).Max(t => t.FechaFin!.Value)
            : DateTime.Now;
        
        return (int)(fin - inicio).TotalDays;
    }

    private int CalcularProgreso()
    {
        if (!tareas.Any()) return 0;
        
        var completadas = tareas.Count(t => t.Estado == EstadoTarea.Finalizado);
        return (int)((double)completadas / tareas.Count * 100);
    }

    private string ObtenerFechaFinEstimada()
    {
        var tareasConFin = tareas.Where(t => t.FechaFin.HasValue).ToList();
        if (!tareasConFin.Any()) return "N/A";
        
        return tareasConFin.Max(t => t.FechaFin!.Value).ToString("dd/MM/yyyy");
    }

    private void Volver()
    {
        Navigation.NavigateTo("/proyectos");
    }

    private int ObtenerDuracionDias(Tarea tarea)
    {
        if (!tarea.FechaFin.HasValue)
        {
            return 1;
        }

        var dias = (int)Math.Ceiling((tarea.FechaFin.Value - tarea.FechaInicio).TotalDays);
        return Math.Max(1, dias);
    }

    private int ObtenerProgresoTarea(Tarea tarea)
    {
        return tarea.Estado switch
        {
            EstadoTarea.Finalizado => 100,
            EstadoTarea.EnCurso => 60,
            EstadoTarea.Bloqueado => 25,
            EstadoTarea.Pendiente => 0,
            _ => 0
        };
    }

    private string ObtenerClaseBarra(EstadoTarea estado)
    {
        return estado switch
        {
            EstadoTarea.Finalizado => "bar-finalizado",
            EstadoTarea.EnCurso => "bar-encurso",
            EstadoTarea.Pendiente => "bar-pendiente",
            EstadoTarea.Bloqueado => "bar-bloqueado",
            _ => "bar-pendiente"
        };
    }

    private bool EsFinDeSemana(DateTime fecha)
    {
        return vistaSeleccionada == "dia" && (fecha.DayOfWeek == DayOfWeek.Saturday || fecha.DayOfWeek == DayOfWeek.Sunday);
    }

    private bool EsHoyVisible()
    {
        return DateTime.Today >= fechaInicio && DateTime.Today <= fechaFin;
    }

    private int ObtenerLeftHoy()
    {
        var dias = (DateTime.Today - fechaInicio).TotalDays;
        return (int)Math.Round((dias / DiasPorCelda()) * anchoColumnaPx);
    }

    private int AnchoTimelinePx()
    {
        return fechasTimeline.Count * anchoColumnaPx;
    }

    private record TimelineHeaderGroup(string Label, int Span);
}
