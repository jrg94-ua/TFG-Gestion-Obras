@page "/proyectos"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using GestionObras.Core.Entities
@using GestionObras.Infrastructure.Repositories
@using GestionObras.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@inject IProyectoRepository ProyectoRepository
@inject GestionObrasDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Proyectos - Gesti√≥n de Obras</PageTitle>

<div class="proyectos-container">
    <div class="page-header">
        <h1>üèóÔ∏è Gesti√≥n de Proyectos</h1>
        <button class="btn btn-primary" @onclick="AbrirModalNuevo">
            <i class="bi bi-plus-circle"></i> Nuevo Proyecto
        </button>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Filtrar por estado:</label>
                <select class="form-select" @onchange="FiltrarPorEstado">
                    <option value="">Todos los estados</option>
                    <option value="@EstadoProyecto.Planificacion">Planificaci√≥n</option>
                    <option value="@EstadoProyecto.EnCurso">En Curso</option>
                    <option value="@EstadoProyecto.Bloqueado">Bloqueado</option>
                    <option value="@EstadoProyecto.Finalizado">Finalizado</option>
                    <option value="@EstadoProyecto.Cancelado">Cancelado</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Buscar:</label>
                <input type="text" class="form-control" placeholder="Nombre del proyecto..." @bind="busqueda" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <!-- Tabla de Proyectos -->
    <div class="proyectos-table-container">
        @if (proyectosFiltrados == null)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        }
        else if (!proyectosFiltrados.Any())
        {
            <div class="empty-state">
                <i class="bi bi-folder2-open"></i>
                <h3>No hay proyectos</h3>
                <p>Comienza creando tu primer proyecto</p>
                <button class="btn btn-primary mt-3" @onclick="AbrirModalNuevo">
                    <i class="bi bi-plus-circle"></i> Crear Proyecto
                </button>
            </div>
        }
        else
        {
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Vista</h5>
                <div class="btn-group" role="group" aria-label="Selector de vista">
                    <button type="button" class="btn @(vistaGanttProyectos ? "btn-outline-primary" : "btn-primary")" @onclick='() => CambiarVistaProyectos(false)'>
                        <i class="bi bi-table"></i> Tabla
                    </button>
                    <button type="button" class="btn @(vistaGanttProyectos ? "btn-primary" : "btn-outline-primary")" @onclick='() => CambiarVistaProyectos(true)'>
                        <i class="bi bi-bar-chart-steps"></i> Gantt Proyectos
                    </button>
                </div>
            </div>

            @if (!vistaGanttProyectos)
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Responsable</th>
                                <th>Ubicaci√≥n</th>
                                <th>Estado</th>
                                <th>Fecha Inicio</th>
                                <th>Tareas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var proyecto in proyectosFiltrados)
                            {
                                <tr>
                                    <td>
                                        <strong>@proyecto.Nombre</strong>
                                    </td>
                                    <td>
                                        @if (proyecto.Responsable != null)
                                        {
                                            <span class="badge bg-primary">
                                                <i class="bi bi-person-badge"></i> @proyecto.Responsable.NombreCompleto
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted"><i class="bi bi-dash"></i> Sin asignar</span>
                                        }
                                    </td>
                                    <td>
                                        <i class="bi bi-geo-alt"></i> @proyecto.Municipio, @proyecto.Provincia
                                    </td>
                                    <td>
                                        <span class="badge @GetEstadoBadgeClass(proyecto.Estado)">
                                            @GetEstadoTexto(proyecto.Estado)
                                        </span>
                                    </td>
                                    <td>@proyecto.FechaInicio.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <span class="badge bg-info">@proyecto.Tareas.Count tareas</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => AbrirKanban(proyecto.Id)" title="Tablero Kanban">
                                                <i class="bi bi-kanban"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => VerGantt(proyecto.Id)" title="Diagrama de Gantt">
                                                <i class="bi bi-bar-chart-steps"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" @onclick="() => VerHistorialMateriales(proyecto.Id)" title="Historial de Materiales">
                                                <i class="bi bi-box-seam"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => VerDetalle(proyecto.Id)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" @onclick="() => AbrirModalEditar(proyecto)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmarEliminar(proyecto)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="proyectos-gantt card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="proyectos-gantt-legend">
                            <span class="legend-title">Leyenda:</span>
                            <span class="legend-item"><span class="legend-dot bar-planificacion"></span> Planificaci√≥n</span>
                            <span class="legend-item"><span class="legend-dot bar-encurso"></span> En Curso</span>
                            <span class="legend-item"><span class="legend-dot bar-bloqueado"></span> Bloqueado</span>
                            <span class="legend-item"><span class="legend-dot bar-finalizado"></span> Finalizado</span>
                            <span class="legend-item"><span class="legend-dot bar-cancelado"></span> Cancelado</span>
                            <span class="legend-item"><span class="legend-marker"></span> Inicio visual</span>
                        </div>

                        <div class="proyectos-gantt-scroll">
                            <div class="proyectos-gantt-header" style="min-width: @(220 + AnchoTimelineProyectosPx())px;">
                                <div class="proyectos-gantt-left">Proyecto</div>
                                <div class="proyectos-gantt-right" style="width: @AnchoTimelineProyectosPx()px;">
                                    @foreach (var mes in mesesTimeline)
                                    {
                                        <div class="proyectos-gantt-month" style="width:@($"{anchoMesPx}px");">
                                            @mes.ToString("MMM yyyy", new CultureInfo("es-ES"))
                                        </div>
                                    }
                                </div>
                            </div>

                            @foreach (var proyecto in proyectosFiltrados.OrderBy(p => p.FechaInicio))
                            {
                                var barra = CalcularBarraProyecto(proyecto);
                                var fechaFin = ObtenerFechaFinProyecto(proyecto);

                                <div class="proyectos-gantt-row" style="min-width: @(220 + AnchoTimelineProyectosPx())px;">
                                    <div class="proyectos-gantt-left">
                                        <div class="fw-semibold text-truncate" title="@proyecto.Nombre">@proyecto.Nombre</div>
                                        <small class="text-muted">@proyecto.FechaInicio.ToString("dd/MM/yyyy") - @fechaFin.ToString("dd/MM/yyyy")</small>
                                    </div>
                                    <div class="proyectos-gantt-right" style="width: @AnchoTimelineProyectosPx()px;">
                                        <div class="proyectos-gantt-track"></div>
                                        <div class="proyectos-gantt-start-marker" style="left: @(barra.Left)px;" title="Inicio: @proyecto.FechaInicio.ToString("dd/MM/yyyy")"></div>
                                        <div class="proyectos-gantt-start-label" style="left: @(ObtenerLeftEtiquetaInicio(barra.Left))px;">@proyecto.FechaInicio.ToString("dd/MM")</div>
                                        <div class="proyectos-gantt-bar @ObtenerClaseBarraProyecto(proyecto.Estado)"
                                             style="left: @(barra.Left)px; width: @(barra.Width)px;"
                                             title="@proyecto.Nombre&#10;Inicio: @proyecto.FechaInicio.ToString("dd/MM/yyyy")&#10;Fin: @fechaFin.ToString("dd/MM/yyyy")&#10;Estado: @GetEstadoTexto(proyecto.Estado)">
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<style>
    .proyectos-gantt-legend {
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
        padding: 12px 14px;
        border-bottom: 1px solid #eef1f6;
        background: #ffffff;
    }

    .legend-title {
        font-weight: 600;
        color: #495057;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #5c6470;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .legend-marker {
        width: 2px;
        height: 14px;
        background: #212529;
        display: inline-block;
        border-radius: 1px;
    }

    .proyectos-gantt-scroll {
        overflow-x: auto;
        overflow-y: hidden;
    }

    .proyectos-gantt-header,
    .proyectos-gantt-row {
        display: flex;
        border-bottom: 1px solid #eef1f6;
    }

    .proyectos-gantt-header {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 2;
    }

    .proyectos-gantt-left {
        width: 220px;
        min-width: 220px;
        padding: 12px;
        border-right: 1px solid #eef1f6;
        background: #fff;
    }

    .proyectos-gantt-right {
        position: relative;
        display: flex;
        height: 72px;
        min-height: 72px;
    }

    .proyectos-gantt-month {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        border-right: 1px solid #eef1f6;
        text-transform: capitalize;
    }

    .proyectos-gantt-track {
        position: absolute;
        top: 58%;
        left: 0;
        width: 100%;
        height: 8px;
        transform: translateY(-50%);
        background: #f1f4f9;
        border-radius: 999px;
    }

    .proyectos-gantt-start-marker {
        position: absolute;
        top: 18px;
        height: 38px;
        width: 2px;
        background: #212529;
        border-radius: 2px;
        z-index: 3;
    }

    .proyectos-gantt-start-label {
        position: absolute;
        top: 2px;
        transform: translateX(-50%);
        font-size: 11px;
        font-weight: 600;
        color: #212529;
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 999px;
        padding: 1px 6px;
        line-height: 1.2;
        z-index: 4;
        white-space: nowrap;
    }

    .proyectos-gantt-bar {
        position: absolute;
        top: 58%;
        height: 20px;
        transform: translateY(-50%);
        border-radius: 999px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        z-index: 2;
    }

    .bar-planificacion { background: #0dcaf0; }
    .bar-encurso { background: #198754; }
    .bar-bloqueado { background: #ffc107; }
    .bar-finalizado { background: #6c757d; }
    .bar-cancelado { background: #dc3545; }
</style>

<!-- Modal Crear/Editar Proyecto -->
@if (mostrarModal)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(proyectoSeleccionado?.Id > 0 ? "Editar Proyecto" : "Nuevo Proyecto")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <EditForm Model="@proyectoForm" OnValidSubmit="@GuardarProyecto">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">Nombre del Proyecto*</label>
                                <InputText class="form-control" @bind-Value="proyectoForm.Nombre" placeholder="Ej: Construcci√≥n Edificio Residencial" />
                                <ValidationMessage For="@(() => proyectoForm.Nombre)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Provincia*</label>
                                <InputSelect class="form-select" @bind-Value="proyectoForm.Provincia">
                                    <option value="">Seleccionar...</option>
                                    <option value="Madrid">Madrid</option>
                                    <option value="Barcelona">Barcelona</option>
                                    <option value="Valencia">Valencia</option>
                                    <option value="Sevilla">Sevilla</option>
                                    <option value="M√°laga">M√°laga</option>
                                    <option value="Murcia">Murcia</option>
                                    <option value="Alicante">Alicante</option>
                                    <option value="Zaragoza">Zaragoza</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => proyectoForm.Provincia)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Municipio*</label>
                                <InputText class="form-control" @bind-Value="proyectoForm.Municipio" placeholder="Nombre del municipio" />
                                <ValidationMessage For="@(() => proyectoForm.Municipio)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Tipo de Suelo*</label>
                                <InputSelect class="form-select" @bind-Value="proyectoForm.TipoSuelo">
                                    <option value="@TipoSuelo.Urbano">Urbano</option>
                                    <option value="@TipoSuelo.Rustico">R√∫stico</option>
                                </InputSelect>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Zona Clim√°tica*</label>
                                <InputSelect class="form-select" @bind-Value="proyectoForm.ZonaClimatica">
                                    <option value="@ZonaClimatica.A3">A3 - C√°diz, M√°laga</option>
                                    <option value="@ZonaClimatica.B3">B3 - Valencia, Murcia</option>
                                    <option value="@ZonaClimatica.C3">C3 - Madrid</option>
                                    <option value="@ZonaClimatica.D3">D3 - Zaragoza</option>
                                    <option value="@ZonaClimatica.E1">E1 - Burgos, Le√≥n</option>
                                </InputSelect>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Fecha de Inicio*</label>
                                <InputDate class="form-control" @bind-Value="proyectoForm.FechaInicio" />
                                <ValidationMessage For="@(() => proyectoForm.FechaInicio)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Fecha Fin Estimada</label>
                                <InputDate class="form-control" @bind-Value="proyectoForm.FechaFin" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Responsable del Proyecto*</label>
                                <InputSelect class="form-select" @bind-Value="proyectoForm.ResponsableId">
                                    <option value="">Seleccionar responsable...</option>
                                    @foreach (var usuario in usuariosResponsables)
                                    {
                                        <option value="@usuario.Id">@usuario.NombreCompleto - @usuario.Cargo</option>
                                    }
                                </InputSelect>
                                <small class="form-text text-muted">Solo usuarios con rol Oficina T√©cnica o Jefe de Obra</small>
                                <ValidationMessage For="@(() => proyectoForm.ResponsableId)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Estado</label>
                                <InputSelect class="form-select" @bind-Value="proyectoForm.Estado">
                                    <option value="@EstadoProyecto.Planificacion">Planificaci√≥n</option>
                                    <option value="@EstadoProyecto.EnCurso">En Curso</option>
                                    <option value="@EstadoProyecto.Bloqueado">Bloqueado</option>
                                    <option value="@EstadoProyecto.Finalizado">Finalizado</option>
                                    <option value="@EstadoProyecto.Cancelado">Cancelado</option>
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" disabled="@guardando">
                            @if (guardando)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Guardar
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<Proyecto> proyectos = new();
    private List<Proyecto> proyectosFiltrados = new();
    private List<UsuarioObra> usuariosResponsables = new();
    private Proyecto? proyectoSeleccionado;
    private ProyectoFormModel proyectoForm = new();
    private bool mostrarModal = false;
    private bool guardando = false;
    private string busqueda = "";
    private string? estadoFiltro;
    private bool vistaGanttProyectos = false;
    private readonly int anchoMesPx = 120;
    private DateTime ganttInicio = DateTime.Today;
    private DateTime ganttFin = DateTime.Today;
    private List<DateTime> mesesTimeline = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarProyectos();
        await CargarUsuariosResponsables();
    }

    private async Task CargarProyectos()
    {
        proyectos = await ProyectoRepository.GetAllAsync();
        AplicarFiltros();
    }

    private async Task CargarUsuariosResponsables()
    {
        // Solo usuarios con rol OficinaTecnica o JefeObra
        var roles = new[] { "OficinaTecnica", "JefeObra" };
        
        usuariosResponsables = await DbContext.Users
            .Where(u => DbContext.UserRoles
                .Any(ur => ur.UserId == u.Id && 
                     DbContext.Roles.Any(r => r.Id == ur.RoleId && roles.Contains(r.Name))))
            .OrderBy(u => u.NombreCompleto)
            .ToListAsync();
    }

    private void AplicarFiltros()
    {
        proyectosFiltrados = proyectos;

        if (!string.IsNullOrWhiteSpace(estadoFiltro))
        {
            if (Enum.TryParse<EstadoProyecto>(estadoFiltro, out var estado))
            {
                proyectosFiltrados = proyectosFiltrados.Where(p => p.Estado == estado).ToList();
            }
        }

        if (!string.IsNullOrWhiteSpace(busqueda))
        {
            proyectosFiltrados = proyectosFiltrados
                .Where(p => p.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
                           p.Municipio.Contains(busqueda, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        RecalcularTimelineProyectos();
    }

    private void FiltrarPorEstado(ChangeEventArgs e)
    {
        estadoFiltro = e.Value?.ToString();
        AplicarFiltros();
    }

    private void CambiarVistaProyectos(bool esGantt)
    {
        vistaGanttProyectos = esGantt;
        if (esGantt)
        {
            RecalcularTimelineProyectos();
        }
    }

    private void RecalcularTimelineProyectos()
    {
        mesesTimeline = new();

        if (!proyectosFiltrados.Any())
        {
            ganttInicio = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
            ganttFin = ganttInicio.AddMonths(1).AddDays(-1);
            mesesTimeline.Add(ganttInicio);
            return;
        }

        var inicioMin = proyectosFiltrados.Min(p => p.FechaInicio);
        var finMax = proyectosFiltrados.Max(p => ObtenerFechaFinProyecto(p));

        ganttInicio = new DateTime(inicioMin.Year, inicioMin.Month, 1);
        ganttFin = new DateTime(finMax.Year, finMax.Month, 1).AddMonths(1).AddDays(-1);

        var cursor = ganttInicio;
        while (cursor <= ganttFin)
        {
            mesesTimeline.Add(cursor);
            cursor = cursor.AddMonths(1);
        }
    }

    private int AnchoTimelineProyectosPx()
    {
        var meses = Math.Max(mesesTimeline.Count, 1);
        return meses * anchoMesPx;
    }

    private DateTime ObtenerFechaFinProyecto(Proyecto proyecto)
    {
        if (proyecto.FechaFin.HasValue)
        {
            return proyecto.FechaFin.Value;
        }

        if (proyecto.Tareas != null && proyecto.Tareas.Any())
        {
            return proyecto.Tareas
                .Select(t => t.FechaFin ?? t.FechaInicio)
                .Max();
        }

        return proyecto.FechaInicio.AddDays(30);
    }

    private (int Left, int Width) CalcularBarraProyecto(Proyecto proyecto)
    {
        var inicio = proyecto.FechaInicio;
        var fin = ObtenerFechaFinProyecto(proyecto);

        var totalDias = Math.Max((ganttFin - ganttInicio).TotalDays + 1, 1);
        var leftRatio = Math.Max((inicio - ganttInicio).TotalDays, 0) / totalDias;
        var widthRatio = Math.Max((fin - inicio).TotalDays + 1, 1) / totalDias;

        var left = (int)Math.Round(leftRatio * AnchoTimelineProyectosPx());
        var width = (int)Math.Round(widthRatio * AnchoTimelineProyectosPx());

        return (left, Math.Max(width, 10));
    }

    private int ObtenerLeftEtiquetaInicio(int leftBarra)
    {
        const int margenEtiqueta = 26;
        var minimo = margenEtiqueta;
        var maximo = Math.Max(AnchoTimelineProyectosPx() - margenEtiqueta, minimo);
        return Math.Clamp(leftBarra, minimo, maximo);
    }

    private string ObtenerClaseBarraProyecto(EstadoProyecto estado)
    {
        return estado switch
        {
            EstadoProyecto.Planificacion => "bar-planificacion",
            EstadoProyecto.EnCurso => "bar-encurso",
            EstadoProyecto.Bloqueado => "bar-bloqueado",
            EstadoProyecto.Finalizado => "bar-finalizado",
            EstadoProyecto.Cancelado => "bar-cancelado",
            _ => "bar-planificacion"
        };
    }

    private void AbrirModalNuevo()
    {
        try
        {
            proyectoSeleccionado = null;
            proyectoForm = new ProyectoFormModel
            {
                FechaInicio = DateTime.Now,
                Estado = EstadoProyecto.Planificacion,
                TipoSuelo = TipoSuelo.Urbano,
                ZonaClimatica = ZonaClimatica.C3,
                ResponsableId = null
            };
            mostrarModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en AbrirModalNuevo: {ex.Message}");
        }
    }

    private void AbrirModalEditar(Proyecto proyecto)
    {
        try
        {
            proyectoSeleccionado = proyecto;
            proyectoForm = new ProyectoFormModel
            {
                Nombre = proyecto.Nombre,
                Provincia = proyecto.Provincia,
                Municipio = proyecto.Municipio,
                TipoSuelo = proyecto.TipoSuelo,
                ZonaClimatica = proyecto.ZonaClimatica,
                FechaInicio = proyecto.FechaInicio,
                FechaFin = proyecto.FechaFin,
                Estado = proyecto.Estado,
                ResponsableId = proyecto.ResponsableId
            };
            mostrarModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en AbrirModalEditar: {ex.Message}");
        }
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        proyectoSeleccionado = null;
    }

    private async Task GuardarProyecto()
    {
        guardando = true;

        try
        {
            if (proyectoSeleccionado == null)
            {
                // Crear nuevo
                var nuevoProyecto = new Proyecto
                {
                    Nombre = proyectoForm.Nombre,
                    Provincia = proyectoForm.Provincia,
                    Municipio = proyectoForm.Municipio,
                    TipoSuelo = proyectoForm.TipoSuelo,
                    ZonaClimatica = proyectoForm.ZonaClimatica,
                    FechaInicio = proyectoForm.FechaInicio,
                    FechaFin = proyectoForm.FechaFin,
                    Estado = proyectoForm.Estado,
                    ResponsableId = proyectoForm.ResponsableId
                };

                await ProyectoRepository.AddAsync(nuevoProyecto);
            }
            else
            {
                // Editar existente
                proyectoSeleccionado.Nombre = proyectoForm.Nombre;
                proyectoSeleccionado.Provincia = proyectoForm.Provincia;
                proyectoSeleccionado.Municipio = proyectoForm.Municipio;
                proyectoSeleccionado.TipoSuelo = proyectoForm.TipoSuelo;
                proyectoSeleccionado.ZonaClimatica = proyectoForm.ZonaClimatica;
                proyectoSeleccionado.FechaInicio = proyectoForm.FechaInicio;
                proyectoSeleccionado.FechaFin = proyectoForm.FechaFin;
                proyectoSeleccionado.Estado = proyectoForm.Estado;
                proyectoSeleccionado.ResponsableId = proyectoForm.ResponsableId;

                await ProyectoRepository.UpdateAsync(proyectoSeleccionado);
            }

            await CargarProyectos();
            CerrarModal();
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task ConfirmarEliminar(Proyecto proyecto)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm", $"¬øEst√°s seguro de eliminar el proyecto '{proyecto.Nombre}'?");

        if (confirmado)
        {
            await ProyectoRepository.DeleteAsync(proyecto.Id);
            await CargarProyectos();
        }
    }

    private void VerDetalle(int id)
    {
        Navigation.NavigateTo($"/proyectos/{id}");
    }

    private void AbrirKanban(int proyectoId)
    {
        Navigation.NavigateTo($"/proyectos/{proyectoId}/kanban");
    }

    private void VerGantt(int proyectoId)
    {
        Navigation.NavigateTo($"/proyectos/{proyectoId}/gantt");
    }

    private void VerHistorialMateriales(int proyectoId)
    {
        Navigation.NavigateTo($"/proyectos/{proyectoId}/historial-materiales");
    }

    private string GetEstadoBadgeClass(EstadoProyecto estado)
    {
        return estado switch
        {
            EstadoProyecto.EnCurso => "bg-success",
            EstadoProyecto.Planificacion => "bg-info",
            EstadoProyecto.Finalizado => "bg-secondary",
            EstadoProyecto.Bloqueado => "bg-warning",
            EstadoProyecto.Cancelado => "bg-danger",
            _ => "bg-primary"
        };
    }

    private string GetEstadoTexto(EstadoProyecto estado)
    {
        return estado switch
        {
            EstadoProyecto.EnCurso => "En Curso",
            EstadoProyecto.Planificacion => "Planificaci√≥n",
            EstadoProyecto.Finalizado => "Finalizado",
            EstadoProyecto.Bloqueado => "Bloqueado",
            EstadoProyecto.Cancelado => "Cancelado",
            _ => estado.ToString()
        };
    }

    public class ProyectoFormModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "El nombre es obligatorio")]
        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 3, ErrorMessage = "El nombre debe tener entre 3 y 100 caracteres")]
        public string Nombre { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "La provincia es obligatoria")]
        public string Provincia { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "El municipio es obligatorio")]
        public string Municipio { get; set; } = string.Empty;

        public TipoSuelo TipoSuelo { get; set; }
        public ZonaClimatica ZonaClimatica { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "La fecha de inicio es obligatoria")]
        public DateTime FechaInicio { get; set; }

        public DateTime? FechaFin { get; set; }
        public EstadoProyecto Estado { get; set; }
        
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Debe seleccionar un responsable")]
        public string? ResponsableId { get; set; }
    }
}
