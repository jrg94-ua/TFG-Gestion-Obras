@page "/jefe-obra/mis-solicitudes-materiales"
@using GestionObras.Core.Entities
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using GestionObras.Infrastructure.Data
@inject GestionObrasDbContext DbContext
@inject UserManager<UsuarioObra> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "JefeObra")]
@rendermode InteractiveServer

<PageTitle>Mis Solicitudes de Materiales - Gestión Obras</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-list-check"></i> Mis Solicitudes de Materiales
        </h1>
        <button class="btn btn-primary" @onclick="NuevaSolicitud">
            <i class="bi bi-cart-plus"></i> Nueva Solicitud
        </button>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select" @bind="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Aprobada">Aprobada</option>
                        <option value="Rechazada">Rechazada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" @bind="filtroProyectoId">
                        <option value="0">Todos los proyectos</option>
                        @foreach (var proyecto in proyectos)
                        {
                            <option value="@proyecto.Id">@proyecto.Nombre</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="text-muted">Pendientes</h6>
                    <h3 class="mb-0 text-warning">@solicitudesFiltradas.Count(s => s.Estado == EstadoSolicitudMaterial.Pendiente)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="text-muted">Aprobadas</h6>
                    <h3 class="mb-0 text-success">@solicitudesFiltradas.Count(s => s.Estado == EstadoSolicitudMaterial.Aprobada)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="text-muted">Rechazadas</h6>
                    <h3 class="mb-0 text-danger">@solicitudesFiltradas.Count(s => s.Estado == EstadoSolicitudMaterial.Rechazada)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-secondary">
                <div class="card-body">
                    <h6 class="text-muted">Total</h6>
                    <h3 class="mb-0">@solicitudesFiltradas.Count()</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de solicitudes -->
    <div class="card">
        <div class="card-body">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Cargando solicitudes...</p>
                </div>
            }
            else if (!solicitudesFiltradas.Any())
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No hay solicitudes para mostrar
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Material</th>
                                <th>Proyecto</th>
                                <th>Cantidad</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var solicitud in solicitudesFiltradas.OrderByDescending(s => s.FechaSolicitud))
                            {
                                <tr>
                                    <td>
                                        <small>@solicitud.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <strong>@solicitud.Material.Nombre</strong>
                                        <br /><small class="text-muted">@solicitud.Material.Codigo</small>
                                    </td>
                                    <td>@solicitud.Proyecto.Nombre</td>
                                    <td>
                                        <strong>@solicitud.CantidadSolicitada @solicitud.Material.UnidadMedida</strong>
                                        <br /><small class="text-muted">@((solicitud.CantidadSolicitada * solicitud.Material.PrecioUnitario).ToString("C"))</small>
                                    </td>
                                    <td>
                                        @switch (solicitud.Prioridad)
                                        {
                                            case PrioridadSolicitud.Urgente:
                                                <span class="badge bg-danger">Urgente</span>
                                                break;
                                            case PrioridadSolicitud.Alta:
                                                <span class="badge bg-warning">Alta</span>
                                                break;
                                            case PrioridadSolicitud.Media:
                                                <span class="badge bg-info">Media</span>
                                                break;
                                            case PrioridadSolicitud.Baja:
                                                <span class="badge bg-secondary">Baja</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        @switch (solicitud.Estado)
                                        {
                                            case EstadoSolicitudMaterial.Pendiente:
                                                <span class="badge bg-warning text-dark">
                                                    <i class="bi bi-clock"></i> Pendiente
                                                </span>
                                                break;
                                            case EstadoSolicitudMaterial.Aprobada:
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Aprobada
                                                </span>
                                                break;
                                            case EstadoSolicitudMaterial.Rechazada:
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-x-circle"></i> Rechazada
                                                </span>
                                                break;
                                            case EstadoSolicitudMaterial.Cancelada:
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-slash-circle"></i> Cancelada
                                                </span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => VerDetalle(solicitud)">
                                            <i class="bi bi-eye"></i> Ver
                                        </button>
                                        @if (solicitud.Estado == EstadoSolicitudMaterial.Pendiente)
                                        {
                                            <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => CancelarSolicitud(solicitud)">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal detalle -->
@if (mostrarModal && solicitudSeleccionada != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-text"></i> Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Estado:</strong>
                            @switch (solicitudSeleccionada.Estado)
                            {
                                case EstadoSolicitudMaterial.Pendiente:
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                    break;
                                case EstadoSolicitudMaterial.Aprobada:
                                    <span class="badge bg-success">Aprobada</span>
                                    break;
                                case EstadoSolicitudMaterial.Rechazada:
                                    <span class="badge bg-danger">Rechazada</span>
                                    break;
                                case EstadoSolicitudMaterial.Cancelada:
                                    <span class="badge bg-secondary">Cancelada</span>
                                    break;
                            }
                        </div>
                        <div class="col-md-6">
                            <strong>Fecha Solicitud:</strong>
                            <p>@solicitudSeleccionada.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    </div>

                    <hr />

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Material:</strong>
                            <p>@solicitudSeleccionada.Material.Nombre (@solicitudSeleccionada.Material.Codigo)</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Proyecto:</strong>
                            <p>@solicitudSeleccionada.Proyecto.Nombre</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Prioridad:</strong>
                            <p>@solicitudSeleccionada.Prioridad</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Cantidad Solicitada:</strong>
                            <p>@solicitudSeleccionada.CantidadSolicitada @solicitudSeleccionada.Material.UnidadMedida</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Coste Estimado:</strong>
                            <p>@((solicitudSeleccionada.CantidadSolicitada * solicitudSeleccionada.Material.PrecioUnitario).ToString("C"))</p>
                        </div>
                    </div>

                    @if (solicitudSeleccionada.FechaNecesaria.HasValue)
                    {
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <strong>Fecha Necesaria:</strong>
                                <p>@solicitudSeleccionada.FechaNecesaria.Value.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>
                    }

                    <div class="mb-3">
                        <strong>Justificación:</strong>
                        <p class="border p-2 rounded">@solicitudSeleccionada.Justificacion</p>
                    </div>

                    @if (solicitudSeleccionada.Estado != EstadoSolicitudMaterial.Pendiente)
                    {
                        <hr />
                        <div class="mb-3">
                            <strong>Fecha Respuesta:</strong>
                            <p>@solicitudSeleccionada.FechaRespuesta?.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>

                        @if (solicitudSeleccionada.RevisadoPor != null)
                        {
                            <div class="mb-3">
                                <strong>Revisado por:</strong>
                                <p>@solicitudSeleccionada.RevisadoPor.NombreCompleto</p>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(solicitudSeleccionada.ObservacionesAdmin))
                        {
                            <div class="mb-3">
                                <strong>Observaciones del Administrador:</strong>
                                <p class="border p-2 rounded bg-light">@solicitudSeleccionada.ObservacionesAdmin</p>
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool cargando = true;
    private List<SolicitudMaterial> solicitudes = new();
    private List<Proyecto> proyectos = new();
    private string filtroEstado = string.Empty;
    private int filtroProyectoId = 0;
    private string usuarioActualId = string.Empty;

    private bool mostrarModal = false;
    private SolicitudMaterial? solicitudSeleccionada;

    private IEnumerable<SolicitudMaterial> solicitudesFiltradas =>
        solicitudes.Where(s =>
            (string.IsNullOrEmpty(filtroEstado) || s.Estado.ToString() == filtroEstado) &&
            (filtroProyectoId == 0 || s.ProyectoId == filtroProyectoId)
        );

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var usuario = await UserManager.GetUserAsync(user);
                if (usuario != null)
                {
                    usuarioActualId = usuario.Id;
                }
            }

            solicitudes = await DbContext.SolicitudesMateriales
                .Include(s => s.Material)
                .Include(s => s.Proyecto)
                .Include(s => s.SolicitadoPor)
                .Include(s => s.RevisadoPor)
                .Where(s => s.SolicitadoPorId == usuarioActualId)
                .ToListAsync();

            proyectos = await DbContext.Proyectos
                .Where(p => p.ResponsableId == usuarioActualId)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void VerDetalle(SolicitudMaterial solicitud)
    {
        solicitudSeleccionada = solicitud;
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        solicitudSeleccionada = null;
    }

    private async Task CancelarSolicitud(SolicitudMaterial solicitud)
    {
        try
        {
            solicitud.Estado = EstadoSolicitudMaterial.Cancelada;
            await DbContext.SaveChangesAsync();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void NuevaSolicitud()
    {
        Navigation.NavigateTo("/jefe-obra/solicitar-materiales");
    }
}
