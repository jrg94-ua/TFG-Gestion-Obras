@page "/proyectos/{ProyectoId:int}/kanban"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using GestionObras.Core.Entities
@using GestionObras.Infrastructure.Repositories
@using GestionObras.Infrastructure.Data
@using GestionObras.Web.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject GestionObrasDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<UsuarioObra> UserManager
@rendermode InteractiveServer

<PageTitle>Tablero Kanban - @proyecto?.Nombre</PageTitle>

@if (proyecto == null)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else if (!esResponsable)
{
    <div class="container mt-5">
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Acceso Denegado</h4>
            <p>Solo el responsable del proyecto o un administrador puede gestionar el tablero Kanban.</p>
            <hr>
            <p class="mb-0">
                <strong>Responsable del proyecto:</strong> @(proyecto.Responsable?.NombreCompleto ?? "No asignado")
            </p>
            <button class="btn btn-outline-secondary mt-3" @onclick="VolverProyectos">
                <i class="bi bi-arrow-left"></i> Volver a Proyectos
            </button>
        </div>
    </div>
}
else
{
    <div class="kanban-container">
        <!-- Header -->
        <div class="kanban-header">
            <div>
                <button class="btn btn-outline-secondary" @onclick="VolverProyectos">
                    <i class="bi bi-arrow-left"></i> Volver a Proyectos
                </button>
                <h1 class="d-inline-block ms-3">üìã Tablero Kanban: @proyecto.Nombre</h1>
            </div>
            <button class="btn btn-primary" @onclick="AbrirModalNuevaTarea">
                <i class="bi bi-plus-circle"></i> Nueva Tarea
            </button>
        </div>

        <!-- Filtros -->
        <div class="kanban-filters">
            <input type="text" class="form-control" style="max-width: 300px;" 
                   placeholder="Buscar tarea..." @bind="busqueda" @bind:event="oninput" />
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="mostrarSubtareas" 
                       @bind="mostrarSubtareas" />
                <label class="form-check-label" for="mostrarSubtareas">
                    Mostrar subtareas expandidas
                </label>
            </div>
        </div>

        <!-- Tablero Kanban -->
        <div class="kanban-board">
            <!-- Columna Pendiente -->
            <div class="kanban-column" 
                 ondragover="event.preventDefault();" 
                 @ondrop="@(() => Drop(EstadoTarea.Pendiente))">
                <div class="kanban-column-header pendiente">
                    <h3>üìù Pendiente</h3>
                    <span class="badge bg-secondary">@ObtenerTareasPorEstado(EstadoTarea.Pendiente).Count()</span>
                </div>
                <div class="kanban-column-body">
                    @foreach (var tarea in ObtenerTareasPorEstado(EstadoTarea.Pendiente))
                    {
                        <TarjetaTarea Tarea="@tarea" 
                                     OnDragStart="@DragStart"
                                     OnEditar="@AbrirModalEditarTarea"
                                     OnEliminar="@ConfirmarEliminar"
                                     OnAgregarSubtarea="@AbrirModalNuevaSubtarea"
                                     OnVerDocumentos="@AbrirModalDocumentos"
                                     OnCompletarTarea="@AbrirModalCompletarTarea"
                                     OnFirmarTarea="@AbrirModalFirmarTarea"
                                     MostrarSubtareas="@mostrarSubtareas" />
                    }
                </div>
            </div>

            <!-- Columna En Curso -->
            <div class="kanban-column" 
                 ondragover="event.preventDefault();" 
                 @ondrop="@(() => Drop(EstadoTarea.EnCurso))">
                <div class="kanban-column-header en-curso">
                    <h3>‚öôÔ∏è En Curso</h3>
                    <span class="badge bg-secondary">@ObtenerTareasPorEstado(EstadoTarea.EnCurso).Count()</span>
                </div>
                <div class="kanban-column-body">
                    @foreach (var tarea in ObtenerTareasPorEstado(EstadoTarea.EnCurso))
                    {
                        <TarjetaTarea Tarea="@tarea" 
                                     OnDragStart="@DragStart"
                                     OnEditar="@AbrirModalEditarTarea"
                                     OnEliminar="@ConfirmarEliminar"
                                     OnAgregarSubtarea="@AbrirModalNuevaSubtarea"
                                     OnVerDocumentos="@AbrirModalDocumentos"
                                     OnCompletarTarea="@AbrirModalCompletarTarea"
                                     OnFirmarTarea="@AbrirModalFirmarTarea"
                                     MostrarSubtareas="@mostrarSubtareas" />
                    }
                </div>
            </div>

            <!-- Columna Bloqueado -->
            <div class="kanban-column" 
                 ondragover="event.preventDefault();" 
                 @ondrop="@(() => Drop(EstadoTarea.Bloqueado))">
                <div class="kanban-column-header bloqueado">
                    <h3>üö´ Bloqueado</h3>
                    <span class="badge bg-secondary">@ObtenerTareasPorEstado(EstadoTarea.Bloqueado).Count()</span>
                </div>
                <div class="kanban-column-body">
                    @foreach (var tarea in ObtenerTareasPorEstado(EstadoTarea.Bloqueado))
                    {
                        <TarjetaTarea Tarea="@tarea" 
                                     OnDragStart="@DragStart"
                                     OnEditar="@AbrirModalEditarTarea"
                                     OnEliminar="@ConfirmarEliminar"
                                     OnAgregarSubtarea="@AbrirModalNuevaSubtarea"
                                     OnDesbloquear="@AbrirModalDesbloquear"
                                     OnVerDocumentos="@AbrirModalDocumentos"
                                     OnCompletarTarea="@AbrirModalCompletarTarea"
                                     OnFirmarTarea="@AbrirModalFirmarTarea"
                                     MostrarSubtareas="@mostrarSubtareas" />
                    }
                </div>
            </div>

            <!-- Columna Finalizado -->
            <div class="kanban-column" 
                 ondragover="event.preventDefault();" 
                 @ondrop="@(() => Drop(EstadoTarea.Finalizado))">
                <div class="kanban-column-header finalizado">
                    <h3>‚úÖ Finalizado</h3>
                    <span class="badge bg-secondary">@ObtenerTareasPorEstado(EstadoTarea.Finalizado).Count()</span>
                </div>
                <div class="kanban-column-body">
                    @foreach (var tarea in ObtenerTareasPorEstado(EstadoTarea.Finalizado))
                    {
                        <TarjetaTarea Tarea="@tarea" 
                                     OnDragStart="@DragStart"
                                     OnEditar="@AbrirModalEditarTarea"
                                     OnEliminar="@ConfirmarEliminar"
                                     OnAgregarSubtarea="@AbrirModalNuevaSubtarea"
                                     OnVerDocumentos="@AbrirModalDocumentos"
                                     OnCompletarTarea="@AbrirModalCompletarTarea"
                                     OnFirmarTarea="@AbrirModalFirmarTarea"
                                     MostrarSubtareas="@mostrarSubtareas" />
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Tarea -->
    @if (mostrarModalTarea)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(tareaEditando?.Id == 0 ? "Nueva Tarea" : "Editar Tarea")</h5>
                        <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@tareaEditando" OnValidSubmit="GuardarTarea">
                            <DataAnnotationsValidator />
                            
                            @if (tareaPadreTemp != null)
                            {
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Subtarea de: <strong>@tareaPadreTemp.Nombre</strong>
                                </div>
                            }
                            
                            <div class="mb-3">
                                <label class="form-label">Nombre *</label>
                                <InputText class="form-control" @bind-Value="tareaEditando.Nombre" />
                                <ValidationMessage For="@(() => tareaEditando.Nombre)" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <InputTextArea class="form-control" rows="3" @bind-Value="tareaEditando.Descripcion" />
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Estado *</label>
                                    <InputSelect class="form-select" @bind-Value="tareaEditando.Estado">
                                        <option value="@EstadoTarea.Pendiente">Pendiente</option>
                                        <option value="@EstadoTarea.EnCurso">En Curso</option>
                                        <option value="@EstadoTarea.Bloqueado">Bloqueado</option>
                                        <option value="@EstadoTarea.Finalizado">Finalizado</option>
                                    </InputSelect>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Prioridad *</label>
                                    <InputSelect class="form-select" @bind-Value="tareaEditando.Prioridad">
                                        <option value="@PrioridadTarea.Baja">Baja</option>
                                        <option value="@PrioridadTarea.Media">Media</option>
                                        <option value="@PrioridadTarea.Alta">Alta</option>
                                        <option value="@PrioridadTarea.Critica">Cr√≠tica</option>
                                    </InputSelect>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fecha Inicio *</label>
                                    <InputDate class="form-control" @bind-Value="tareaEditando.FechaInicio" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fecha Fin</label>
                                    <InputDate class="form-control" @bind-Value="tareaEditando.FechaFin" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Presupuesto Estimado (‚Ç¨)</label>
                                    <InputNumber class="form-control" @bind-Value="tareaEditando.PresupuestoEstimado" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Costes Reales (‚Ç¨)</label>
                                    <InputNumber class="form-control" @bind-Value="tareaEditando.CostesReales" />
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <InputCheckbox class="form-check-input" @bind-Value="tareaEditando.RequiereFirmaConjunta" id="requiereFirmaConjunta" />
                                    <label class="form-check-label" for="requiereFirmaConjunta">
                                        <strong>Tarea Conjunta - Requiere firma de todos los usuarios asignados</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Si est√° marcado, todos los usuarios asignados deben firmar antes de que la tarea pueda ser completada
                                    </small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Responsables *</label>
                                <select class="form-select" multiple @onchange="AsignarResponsables" size="5">
                                    @foreach (var empleado in empleadosDisponibles)
                                    {
                                        var seleccionado = responsablesSeleccionados.Contains(empleado.Id);
                                        <option value="@empleado.Id" selected="@seleccionado">
                                            @empleado.NombreCompleto (@empleado.Cargo)
                                        </option>
                                    }
                                </select>
                                <small class="form-text text-muted">
                                    Mantenga presionada la tecla Ctrl (Windows) o Command (Mac) para seleccionar m√∫ltiples responsables
                                </small>
                                @if (responsablesSeleccionados.Any())
                                {
                                    <div class="mt-2">
                                        <strong>Seleccionados:</strong>
                                        @foreach (var userId in responsablesSeleccionados)
                                        {
                                            var emp = empleadosDisponibles.FirstOrDefault(e => e.Id == userId);
                                            if (emp != null)
                                            {
                                                <span class="badge bg-primary me-1">@emp.NombreCompleto</span>
                                            }
                                        }
                                    </div>
                                }
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Guardar
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal de Bloqueo (RF-07) -->
    @if (mostrarModalBloqueo)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">üö´ Justificar Bloqueo de Tarea</h5>
                        <button type="button" class="btn-close" @onclick="CerrarModalBloqueo"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>RF-07:</strong> Es obligatorio justificar el bloqueo de una tarea.
                        </div>
                        
                        <p><strong>Tarea:</strong> @tareaParaBloquear?.Nombre</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Bloqueo *</label>
                            <select class="form-select" @bind="tipoBloqueoSeleccionado">
                                <option value="@TipoBloqueo.FaltaMaterial">Falta de Material</option>
                                <option value="@TipoBloqueo.ErrorEjecucion">Error de Ejecuci√≥n</option>
                                <option value="@TipoBloqueo.IncidenciaNormativa">Incidencia Normativa</option>
                                <option value="@TipoBloqueo.ClimatologiaAdversa">Climatolog√≠a Adversa</option>
                                <option value="@TipoBloqueo.Otro">Otro</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Justificaci√≥n T√©cnica *</label>
                            <textarea class="form-control" rows="4" @bind="justificacionBloqueo"
                                      placeholder="Describa detalladamente el motivo del bloqueo..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalBloqueo">Cancelar</button>
                        <button type="button" class="btn btn-warning" @onclick="GuardarBloqueo">
                            <i class="bi bi-lock"></i> Bloquear Tarea
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal de Desbloqueo -->
    @if (mostrarModalDesbloqueo)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">‚úÖ Desbloquear Tarea</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalDesbloqueo"></button>
                    </div>
                    <div class="modal-body">
                        @if (tareaParaDesbloquear?.Bloqueo != null)
                        {
                            <div class="mb-3">
                                <strong>Tarea:</strong> @tareaParaDesbloquear.Nombre
                            </div>
                            <div class="mb-3">
                                <strong>Motivo del bloqueo:</strong> @tareaParaDesbloquear.Bloqueo.Tipo
                            </div>
                            <div class="mb-3">
                                <strong>Justificaci√≥n:</strong><br />
                                @tareaParaDesbloquear.Bloqueo.JustificacionTecnica
                            </div>
                            <div class="mb-3">
                                <strong>Fecha de bloqueo:</strong> @tareaParaDesbloquear.Bloqueo.FechaBloqueo.ToString("dd/MM/yyyy")
                            </div>
                        }
                        <p class="text-success">¬øConfirma que desea desbloquear esta tarea?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalDesbloqueo">Cancelar</button>
                        <button type="button" class="btn btn-success" @onclick="DesbloquearTarea">
                            <i class="bi bi-unlock"></i> Desbloquear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
    
    <!-- Modal de Documentos -->
    @if (mostrarModalDocumentos)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title"><i class="bi bi-paperclip"></i> Documentos de la Tarea</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalDocumentos"></button>
                    </div>
                    <div class="modal-body">
                        <h6>@tareaParaDocumentos?.Nombre</h6>
                        <hr />
                        
                        <!-- Formulario para subir documento -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong><i class="bi bi-cloud-upload"></i> Adjuntar nuevo documento</strong>
                            </div>
                            <div class="card-body">
                                <p class="text-info">
                                    <i class="bi bi-info-circle"></i> 
                                    Por favor, sube el documento desde tu ordenador. 
                                    La funcionalidad de carga estar√° disponible pr√≥ximamente.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Lista de documentos -->
                        @if (documentosTarea.Any())
                        {
                            <h6 class="mt-3">Documentos adjuntos:</h6>
                            <div class="list-group">
                                @foreach (var doc in documentosTarea)
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="bi bi-file-earmark"></i> @doc.NombreArchivo
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    <span class="badge bg-secondary">@doc.TipoDocumento</span>
                                                    Tama√±o: @((doc.Tama√±oBytes / 1024.0).ToString("N2")) KB
                                                </p>
                                                @if (!string.IsNullOrEmpty(doc.Descripcion))
                                                {
                                                    <p class="mb-1"><small>@doc.Descripcion</small></p>
                                                }
                                                <p class="mb-0 text-muted small">
                                                    Subido por: <strong>@doc.UsuarioSubida?.NombreCompleto</strong> el @doc.FechaSubida.ToString("dd/MM/yyyy HH:mm")
                                                </p>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-danger" title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No hay documentos adjuntos para esta tarea.
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalDocumentos">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
    
    <!-- Modal de Completar Tarea -->
    @if (mostrarModalCompletarTarea)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="bi bi-check-circle"></i> Completar Tarea</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalCompletarTarea"></button>
                    </div>
                    <div class="modal-body">
                        <h6>@tareaParaCompletar?.Nombre</h6>
                        <hr />
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Al completar esta tarea, se registrar√° tu nombre y la fecha actual como firma digital.
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Observaciones de finalizaci√≥n (opcional)</label>
                            <textarea class="form-control" rows="4" 
                                      @bind="observacionesFinalizacion"
                                      placeholder="A√±ade cualquier observaci√≥n o comentario sobre la finalizaci√≥n de la tarea..."></textarea>
                        </div>
                        
                        <div class="card bg-light">
                            <div class="card-body">
                                <strong>Firma digital:</strong>
                                <p class="mb-0">
                                    <i class="bi bi-person-check"></i> Usuario actual<br/>
                                    <i class="bi bi-calendar-check"></i> @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalCompletarTarea">Cancelar</button>
                        <button type="button" class="btn btn-success" @onclick="CompletarTarea">
                            <i class="bi bi-check-circle"></i> Completar y Firmar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal de Firmar Tarea -->
    @if (mostrarModalFirmar)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="bi bi-pen"></i> Firmar Tarea Conjunta</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalFirmar"></button>
                    </div>
                    <div class="modal-body">
                        <h6>@tareaParaFirmar?.Nombre</h6>
                        <hr />
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Esta tarea requiere la firma de todos los usuarios asignados antes de poder completarse.
                        </div>
                        
                        @if (tareaParaFirmar?.UsuariosAsignados != null)
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">Estado de firmas:</label>
                                <div class="list-group">
                                    @foreach (var usuario in tareaParaFirmar.UsuariosAsignados)
                                    {
                                        var haFirmado = tareaParaFirmar.UsuarioHaFirmado(usuario.Id);
                                        var firma = tareaParaFirmar.Firmas?.FirstOrDefault(f => f.UsuarioId == usuario.Id);
                                        
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-person"></i> @usuario.UserName
                                                @if (firma != null)
                                                {
                                                    <br />
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar"></i> @firma.FechaFirma.ToString("dd/MM/yyyy HH:mm")
                                                    </small>
                                                    @if (!string.IsNullOrWhiteSpace(firma.Observaciones))
                                                    {
                                                        <br />
                                                        <small class="text-muted">@firma.Observaciones</small>
                                                    }
                                                    @if (!firma.Aprobada && !string.IsNullOrWhiteSpace(firma.MotivoRechazo))
                                                    {
                                                        <br />
                                                        <small class="text-danger">Rechazada: @firma.MotivoRechazo</small>
                                                    }
                                                }
                                            </div>
                                            <div>
                                                @if (haFirmado)
                                                {
                                                    @if (firma?.Aprobada == true)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle"></i> Aprobada
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-x-circle"></i> Rechazada
                                                        </span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">
                                                        <i class="bi bi-clock"></i> Pendiente
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        
                        <div class="mb-3">
                            <label class="form-label">Observaciones (opcional)</label>
                            <textarea class="form-control" rows="3" 
                                      @bind="observacionesFirma"
                                      placeholder="A√±ade cualquier comentario sobre tu firma..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalFirmar">Cancelar</button>
                        <button type="button" class="btn btn-danger" @onclick='async () => await FirmarTarea(false)'>
                            <i class="bi bi-x-circle"></i> Rechazar
                        </button>
                        <button type="button" class="btn btn-success" @onclick='async () => await FirmarTarea(true)'>
                            <i class="bi bi-check-circle"></i> Aprobar y Firmar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
}

@code {
    [Parameter]
    public int ProyectoId { get; set; }

    private Proyecto? proyecto;
    private List<Tarea> tareas = new();
    private List<Tarea> tareasFiltradas = new();
    private List<UsuarioObra> empleadosDisponibles = new();
    private List<string> responsablesSeleccionados = new();
    private string busqueda = "";
    private bool mostrarSubtareas = true;
    private bool esResponsable = false;
    private string? usuarioActualId;

    // Modal Tarea
    private bool mostrarModalTarea = false;
    private Tarea tareaEditando = new();
    private Tarea? tareaPadreTemp = null;

    // Drag and Drop
    private Tarea? tareaArrastrada = null;

    // Modal Bloqueo
    private bool mostrarModalBloqueo = false;
    private Tarea? tareaParaBloquear = null;
    private TipoBloqueo tipoBloqueoSeleccionado = TipoBloqueo.FaltaMaterial;
    private string justificacionBloqueo = "";

    // Modal Desbloqueo
    private bool mostrarModalDesbloqueo = false;
    private Tarea? tareaParaDesbloquear = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    protected override async Task OnParametersSetAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        // Obtener usuario actual
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var usuario = await UserManager.GetUserAsync(user);
            usuarioActualId = usuario?.Id;
        }

        proyecto = await DbContext.Proyectos
            .Include(p => p.Responsable)
            .Include(p => p.Tareas)
                .ThenInclude(t => t.SubTareas)
            .Include(p => p.Tareas)
                .ThenInclude(t => t.Bloqueo)
            .Include(p => p.Tareas)
                .ThenInclude(t => t.UsuariosAsignados)
            .Include(p => p.Tareas)
                .ThenInclude(t => t.Documentos)
            .Include(p => p.Tareas)
                .ThenInclude(t => t.CompletadaPor)
            .FirstOrDefaultAsync(p => p.Id == ProyectoId);

        if (proyecto != null)
        {
            // Verificar si el usuario actual es el responsable del proyecto o es administrador
            var roles = await UserManager.GetRolesAsync(await UserManager.FindByIdAsync(usuarioActualId ?? ""));
            esResponsable = proyecto.ResponsableId == usuarioActualId || roles.Contains("Administrador");
            
            tareas = proyecto.Tareas.ToList();
            AplicarFiltros();
        }

        // Cargar empleados disponibles (usuarios del sistema)
        empleadosDisponibles = await DbContext.Users
            .Where(u => u.Activo)
            .OrderBy(u => u.NombreCompleto)
            .ToListAsync();
    }

    private void AplicarFiltros()
    {
        tareasFiltradas = tareas.Where(t => t.TareaPadreId == null).ToList(); // Solo tareas ra√≠z

        if (!string.IsNullOrWhiteSpace(busqueda))
        {
            tareasFiltradas = tareasFiltradas
                .Where(t => t.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
                           (t.Descripcion?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }
    }

    private List<Tarea> ObtenerTareasPorEstado(EstadoTarea estado)
    {
        return tareasFiltradas.Where(t => t.Estado == estado).OrderBy(t => t.Prioridad).ToList();
    }

    // Drag and Drop
    private void DragStart(Tarea tarea)
    {
        tareaArrastrada = tarea;
    }

    private async Task Drop(EstadoTarea nuevoEstado)
    {
        if (tareaArrastrada == null) return;

        // Si se intenta mover a Bloqueado, mostrar modal de justificaci√≥n (RF-07)
        if (nuevoEstado == EstadoTarea.Bloqueado && tareaArrastrada.Estado != EstadoTarea.Bloqueado)
        {
            tareaParaBloquear = tareaArrastrada;
            mostrarModalBloqueo = true;
            tareaArrastrada = null;
            return;
        }

        // Si se desbloquea arrastrando fuera de Bloqueado
        if (tareaArrastrada.Estado == EstadoTarea.Bloqueado && nuevoEstado != EstadoTarea.Bloqueado)
        {
            if (tareaArrastrada.Bloqueo != null)
            {
                tareaArrastrada.Bloqueo.FechaResolucion = DateTime.Now;
            }
        }

        tareaArrastrada.Estado = nuevoEstado;
        DbContext.Update(tareaArrastrada);
        await DbContext.SaveChangesAsync();
        await CargarDatos();
        
        tareaArrastrada = null;
    }

    // Gesti√≥n de Tareas
    private void AbrirModalNuevaTarea()
    {
        tareaEditando = new Tarea
        {
            ProyectoId = ProyectoId,
            FechaInicio = DateTime.Today,
            Estado = EstadoTarea.Pendiente,
            Prioridad = PrioridadTarea.Media,
            Nivel = 0
        };
        tareaPadreTemp = null;
        responsablesSeleccionados = new();
        mostrarModalTarea = true;
    }

    private void AbrirModalNuevaSubtarea(Tarea tareaPadre)
    {
        tareaEditando = new Tarea
        {
            ProyectoId = ProyectoId,
            TareaPadreId = tareaPadre.Id,
            FechaInicio = DateTime.Today,
            Estado = EstadoTarea.Pendiente,
            Prioridad = PrioridadTarea.Media,
            Nivel = tareaPadre.Nivel + 1
        };
        tareaPadreTemp = tareaPadre;
        responsablesSeleccionados = new();
        mostrarModalTarea = true;
    }

    private void AbrirModalEditarTarea(Tarea tarea)
    {
        tareaEditando = tarea;
        tareaPadreTemp = null;
        responsablesSeleccionados = tarea.UsuariosAsignados?.Select(r => r.Id ?? "").Where(id => !string.IsNullOrEmpty(id)).ToList() ?? new();
        mostrarModalTarea = true;
    }

    private void AsignarResponsables(ChangeEventArgs e)
    {
        if (e.Value is string[] valores)
        {
            responsablesSeleccionados = valores.ToList();
        }
    }

    private async Task GuardarTarea()
    {
        try
        {
            // Asignar usuarios responsables
            if (responsablesSeleccionados.Any())
            {
                var responsables = await DbContext.Users
                    .Where(u => responsablesSeleccionados.Contains(u.Id))
                    .ToListAsync();
                tareaEditando.UsuariosAsignados = responsables;
            }

            if (tareaEditando.Id == 0)
            {
                DbContext.Tareas.Add(tareaEditando);
            }
            else
            {
                DbContext.Update(tareaEditando);
            }

            await DbContext.SaveChangesAsync();
            await CargarDatos();
            CerrarModal();
            await JS.InvokeVoidAsync("alert", "Tarea guardada correctamente");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        responsablesSeleccionados = new();
        }
    }

    private async Task ConfirmarEliminar(Tarea tarea)
    {
        var confirmado = await JS.InvokeAsync<bool>("confirm", $"¬øEst√° seguro de eliminar la tarea '{tarea.Nombre}'?");
        if (confirmado)
        {
            DbContext.Tareas.Remove(tarea);
            await DbContext.SaveChangesAsync();
            await CargarDatos();
            await JS.InvokeVoidAsync("alert", "Tarea eliminada correctamente");
        }
    }

    private void CerrarModal()
    {
        mostrarModalTarea = false;
        tareaEditando = new();
        tareaPadreTemp = null;
    }

    // Gesti√≥n de Bloqueos (RF-07)
    private async Task GuardarBloqueo()
    {
        if (tareaParaBloquear == null || string.IsNullOrWhiteSpace(justificacionBloqueo))
        {
            await JS.InvokeVoidAsync("alert", "Debe proporcionar una justificaci√≥n t√©cnica");
            return;
        }

        var bloqueo = new BloqueoTarea
        {
            TareaId = tareaParaBloquear.Id,
            Tipo = tipoBloqueoSeleccionado,
            JustificacionTecnica = justificacionBloqueo,
            FechaBloqueo = DateTime.Now
        };

        tareaParaBloquear.Estado = EstadoTarea.Bloqueado;
        tareaParaBloquear.Bloqueo = bloqueo;

        DbContext.Update(tareaParaBloquear);
        await DbContext.SaveChangesAsync();
        await CargarDatos();

        CerrarModalBloqueo();
        await JS.InvokeVoidAsync("alert", "Tarea bloqueada correctamente");
    }

    private void CerrarModalBloqueo()
    {
        mostrarModalBloqueo = false;
        tareaParaBloquear = null;
        justificacionBloqueo = "";
    }

    private void AbrirModalDesbloquear(Tarea tarea)
    {
        tareaParaDesbloquear = tarea;
        mostrarModalDesbloqueo = true;
    }

    private async Task DesbloquearTarea()
    {
        if (tareaParaDesbloquear?.Bloqueo != null)
        {
            tareaParaDesbloquear.Bloqueo.FechaResolucion = DateTime.Now;
            tareaParaDesbloquear.Estado = EstadoTarea.Pendiente;
            
            DbContext.Update(tareaParaDesbloquear);
            await DbContext.SaveChangesAsync();
            await CargarDatos();

            CerrarModalDesbloqueo();
            await JS.InvokeVoidAsync("alert", "Tarea desbloqueada correctamente");
        }
    }

    private void CerrarModalDesbloqueo()
    {
        mostrarModalDesbloqueo = false;
        tareaParaDesbloquear = null;
    }
    
    // Gesti√≥n de Documentos
    private bool mostrarModalDocumentos = false;
    private Tarea? tareaParaDocumentos = null;
    private List<DocumentoTarea> documentosTarea = new();
    
    private void AbrirModalDocumentos(Tarea tarea)
    {
        tareaParaDocumentos = tarea;
        CargarDocumentosTarea(tarea.Id);
        mostrarModalDocumentos = true;
    }
    
    private async void CargarDocumentosTarea(int tareaId)
    {
        documentosTarea = await DbContext.DocumentosTareas
            .Include(d => d.UsuarioSubida)
            .Where(d => d.TareaId == tareaId)
            .OrderByDescending(d => d.FechaSubida)
            .ToListAsync();
        StateHasChanged();
    }
    
    private void CerrarModalDocumentos()
    {
        mostrarModalDocumentos = false;
        tareaParaDocumentos = null;
        documentosTarea = new();
    }
    
    // Completar tarea con firma
    private bool mostrarModalCompletarTarea = false;
    private Tarea? tareaParaCompletar = null;
    private string observacionesFinalizacion = "";
    
    // Firmar tarea
    private bool mostrarModalFirmar = false;
    private Tarea? tareaParaFirmar = null;
    private string observacionesFirma = "";
    
    private void AbrirModalCompletarTarea(Tarea tarea)
    {
        tareaParaCompletar = tarea;
        observacionesFinalizacion = "";
        mostrarModalCompletarTarea = true;
    }
    
    private async Task CompletarTarea()
    {
        if (tareaParaCompletar != null)
        {
            // Verificar si requiere firma conjunta
            if (tareaParaCompletar.RequiereFirmaConjunta)
            {
                if (!tareaParaCompletar.TodosHanFirmado())
                {
                    await JS.InvokeVoidAsync("alert", 
                        $"Esta tarea requiere la firma de todos los usuarios asignados. " +
                        $"Firmas: {tareaParaCompletar.Firmas.Count(f => f.Aprobada)}/{tareaParaCompletar.UsuariosAsignados.Count}");
                    return;
                }
            }
            
            tareaParaCompletar.Estado = EstadoTarea.Finalizado;
            tareaParaCompletar.FechaFinalizacion = DateTime.Now;
            tareaParaCompletar.CompletadaPorId = usuarioActualId;
            tareaParaCompletar.ObservacionesFinalizacion = observacionesFinalizacion;
            
            DbContext.Update(tareaParaCompletar);
            await DbContext.SaveChangesAsync();
            await CargarDatos();
            
            CerrarModalCompletarTarea();
            await JS.InvokeVoidAsync("alert", "Tarea completada correctamente");
        }
    }
    
    private void CerrarModalCompletarTarea()
    {
        mostrarModalCompletarTarea = false;
        tareaParaCompletar = null;
        observacionesFinalizacion = "";
    }
    
    // Gesti√≥n de firmas
    private void AbrirModalFirmarTarea(Tarea tarea)
    {
        if (tarea.UsuarioHaFirmado(usuarioActualId ?? ""))
        {
            JS.InvokeVoidAsync("alert", "Ya has firmado esta tarea");
            return;
        }
        
        tareaParaFirmar = tarea;
        observacionesFirma = "";
        mostrarModalFirmar = true;
    }
    
    private async Task FirmarTarea(bool aprobada)
    {
        if (tareaParaFirmar != null && !string.IsNullOrWhiteSpace(usuarioActualId))
        {
            var firma = new FirmaTarea
            {
                TareaId = tareaParaFirmar.Id,
                UsuarioId = usuarioActualId,
                FechaFirma = DateTime.Now,
                Observaciones = observacionesFirma,
                Aprobada = aprobada,
                MotivoRechazo = null
            };
            
            DbContext.FirmasTareas.Add(firma);
            await DbContext.SaveChangesAsync();
            await CargarDatos();
            
            CerrarModalFirmar();
            
            var mensaje = aprobada ? "Tarea firmada correctamente" : "Tarea rechazada";
            await JS.InvokeVoidAsync("alert", mensaje);
            
            // Si se rechaza, bloquear la tarea
            if (!aprobada && tareaParaFirmar != null)
            {
                tareaParaFirmar.Estado = EstadoTarea.Bloqueado;
                var bloqueo = new BloqueoTarea
                {
                    TareaId = tareaParaFirmar.Id,
                    Tipo = TipoBloqueo.Otro,
                    JustificacionTecnica = $"Rechazada por usuario {usuarioActualId}",
                    FechaBloqueo = DateTime.Now
                };
                DbContext.BloqueosTareas.Add(bloqueo);
                DbContext.Update(tareaParaFirmar);
                await DbContext.SaveChangesAsync();
                await CargarDatos();
            }
        }
    }
    
    private void CerrarModalFirmar()
    {
        mostrarModalFirmar = false;
        tareaParaFirmar = null;
        observacionesFirma = "";
    }

    private void VolverProyectos()
    {
        Navigation.NavigateTo("/proyectos");
    }
}
